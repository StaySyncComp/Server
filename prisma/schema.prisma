generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    Int                 @id @default(autoincrement())
  name                  String
  email                 String              @unique
  password              String
  userType              UserType
  username              String              @unique
  logo                  String?
  expoPushToken         String[]
  phoneNumber           String?
  assignedCalls         Call[]              @relation("AssignedCalls")
  closedCalls           Call[]              @relation("ClosedCalls")
  createdCalls          Call[]              @relation("CreatedCalls")
  CallMessage           CallMessage[]
  assignedToUser        CallStatusHistory[] @relation("AssignedToUser")
  changedByUser         CallStatusHistory[] @relation("ChangedByUser")
  CallStatusHistory     CallStatusHistory[]
  organizationRoles     OrganizationRole[]
  Organization          Organization[]
  recurringCreatedCalls RecurringCall[]     @relation("UserRecurringCreatedCalls")
  assignedCleaningRooms CleaningRoomState[]
  performedCleaningActions CleaningHistory[]

  @@map("users")
}

model Organization {
  id                Int                @id @default(autoincrement())
  name              String
  logo              String
  years             String[]
  customStyles      Json
  ownerId           Int
  aiSettingsId      Int?
  CallMessage       CallMessage[]
  aiSettings        AiSettings?
  Area              Area[]
  CallCategory      CallCategory[]
  departments       Department[]
  locations         Location[]
  organizationRoles OrganizationRole[]
  owner             User               @relation(fields: [ownerId], references: [id])
  recurringCalls    RecurringCall[]
  Role              Role[]

  @@map("organizations")
}

model Department {
  id               Int                @id @default(autoincrement())
  name             Json
  logo             String?
  organizationId   Int
  Call             Call[]
  CallCategory     CallCategory[]
  organization     Organization       @relation(fields: [organizationId], references: [id])
  OrganizationRole OrganizationRole[]
  recurringCalls   RecurringCall[]

  @@map("departments")
}

model Location {
  id             Int             @id @default(autoincrement())
  name           Json
  roomNumber     Int?
  color          String?
  organizationId Int
  areaId         Int
  Call           Call[]
  area           Area            @relation(fields: [areaId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id])
  RecurringCall  RecurringCall[]
  cleaningState  CleaningRoomState?

  @@map("locations")
}

model Area {
  id             Int          @id @default(autoincrement())
  name           Json
  color          String
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id])
  Location       Location[]

  @@map("areas")
}

model Role {
  id                Int                @id @default(autoincrement())
  name              Json
  organizationId    Int
  permissions       Permission[]
  organizationRoles OrganizationRole[]
  organization      Organization       @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
  @@map("roles")
}

model OrganizationRole {
  id             Int          @id @default(autoincrement())
  userId         Int
  organizationId Int
  departmentId   Int?
  roleId         Int
  department     Department?  @relation(fields: [departmentId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  role           Role         @relation(fields: [roleId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, organizationId, departmentId])
  @@map("organizationRoles")
}

model CallCategory {
  id             Int             @id @default(autoincrement())
  name           Json
  departmentId   Int
  organizationId Int
  logo           String
  expectedTime   Int
  calls          Call[]
  department     Department      @relation(fields: [departmentId], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id])
  recurringCalls RecurringCall[]

  @@map("callCategories")
}

model Call {
  id                Int                 @id @default(autoincrement())
  description       String?
  locationId        Int?
  createdAt         DateTime            @default(now())
  closedAt          DateTime?
  departmentId      Int?
  callCategoryId    Int?
  createdById       Int?
  assignedToId      Int?
  closedById        Int?
  organizationId    Int
  recurringCallId   Int?
  status            CallStatus
  updatedAt         DateTime            @updatedAt
  assignedTo        User?               @relation("AssignedCalls", fields: [assignedToId], references: [id])
  callCategory      CallCategory?       @relation(fields: [callCategoryId], references: [id])
  closedBy          User?               @relation("ClosedCalls", fields: [closedById], references: [id])
  createdBy         User?               @relation("CreatedCalls", fields: [createdById], references: [id])
  Department        Department?         @relation(fields: [departmentId], references: [id])
  location          Location?           @relation(fields: [locationId], references: [id])
  recurringCall     RecurringCall?      @relation("RecurringCall_Calls", fields: [recurringCallId], references: [id])
  CallMessage       CallMessage[]
  CallStatusHistory CallStatusHistory[]
}

model Permission {
  id       Int        @id @default(autoincrement())
  roleId   Int
  resource Resource
  action   Action
  scope    ScopeLevel
  role     Role       @relation(fields: [roleId], references: [id])
}

model CleaningRoomState {
  id             Int                @id @default(autoincrement())
  locationId     Int                @unique
  status         RoomCleaningStatus @default(dirty)
  priority       CleaningPriority   @default(normal)
  assignedToId   Int?
  lastCleanedAt  DateTime?
  updatedAt      DateTime           @updatedAt
  
  location       Location           @relation(fields: [locationId], references: [id])
  assignedTo     User?              @relation(fields: [assignedToId], references: [id])
  history        CleaningHistory[]

  @@map("cleaning_room_states")
}

model CleaningHistory {
  id                  Int               @id @default(autoincrement())
  cleaningRoomStateId Int
  action              String
  performedById       Int?
  createdAt           DateTime          @default(now())

  cleaningRoomState   CleaningRoomState @relation(fields: [cleaningRoomStateId], references: [id])
  performedBy         User?             @relation(fields: [performedById], references: [id])

  @@map("cleaning_history")
}

enum RoomCleaningStatus {
  dirty
  in_progress
  clean
  inspected
  do_not_disturb
}

enum CleaningPriority {
  low
  normal
  high
}

model RecurringCall {
  id             Int                @id @default(autoincrement())
  title          String
  description    String?
  departmentId   Int?
  callCategoryId Int?
  createdById    Int
  organizationId Int
  startDate      DateTime
  endDate        DateTime?
  frequency      RecurringFrequency
  interval       Int                @default(1)
  daysOfWeek     Int[]
  times          String[]
  exceptions     DateTime[]         @default(dbgenerated("(ARRAY[]::timestamp without time zone[])::timestamp(3) without time zone[]"))
  baseCallId     Int?
  locationId     Int
  createdCalls   Call[]             @relation("RecurringCall_Calls")
  callCategory   CallCategory?      @relation(fields: [callCategoryId], references: [id])
  createdBy      User               @relation("UserRecurringCreatedCalls", fields: [createdById], references: [id])
  department     Department?        @relation(fields: [departmentId], references: [id])
  location       Location           @relation(fields: [locationId], references: [id])
  organization   Organization       @relation(fields: [organizationId], references: [id])

  @@map("recurringCalls")
}

model CallMessage {
  id                    Int                     @id @default(autoincrement())
  callId                Int
  organizationId        Int
  userId                Int
  content               String?
  createdAt             DateTime                @default(now())
  call                  Call                    @relation(fields: [callId], references: [id])
  organization          Organization            @relation(fields: [organizationId], references: [id])
  user                  User                    @relation(fields: [userId], references: [id])
  CallMessageAttachment CallMessageAttachment[]
}

model AiSettings {
  id             Int          @id @default(autoincrement())
  organizationId Int          @unique
  fileUrls       String[]
  contextText    String?
  updatedAt      DateTime     @updatedAt
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@map("aiSettings")
}

model CallStatusHistory {
  id           Int         @id @default(autoincrement())
  callId       Int
  fromStatus   CallStatus?
  toStatus     CallStatus
  changedAt    DateTime    @default(now())
  changedById  Int?
  assignedToId Int?
  userId       Int?
  assignedTo   User?       @relation("AssignedToUser", fields: [assignedToId], references: [id])
  call         Call        @relation(fields: [callId], references: [id])
  changedBy    User?       @relation("ChangedByUser", fields: [changedById], references: [id])
  User         User?       @relation(fields: [userId], references: [id])
}

model CallMessageAttachment {
  id         Int         @id @default(autoincrement())
  messageId  Int
  fileUrl    String
  fileType   String
  fileName   String
  uploadedAt DateTime    @default(now())
  message    CallMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model icon_vectors {
  id        String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  icon_name String?
  tags      String[]
  keyword   String?
  file      String?
  embedding Unsupported("vector")?
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model interested_people {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String   @unique
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

enum UserType {
  EMPLOYER
  EMPLOYEE
}

enum CallStatus {
  OPENED
  IN_PROGRESS
  COMPLETED
  FAILED
  ON_HOLD
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum Action {
  view
  update
  delete
  create
}

enum Resource {
  users
  calls
  callCategories
  site
  roles
  reports
  departments
  areas
  app
  cleaning
}

enum ScopeLevel {
  any
  own
  none
}
